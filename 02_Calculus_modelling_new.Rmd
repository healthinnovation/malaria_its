---
title: "02_Calculus_model"
output: html_document
date: "2023-11-16"
---


# Load data

* Se busca predecir el periodo post al periodo de intervencion, 2006 al 2010


## PAMAFRO

```{r,message=F,warning=F}

library(tidymodels)
library(modeltime)
library(timetk)
library(tidyverse)


db.pamafro        <- readRDS("db_loreto_its.rds") %>% 
                     filter(year<=2010)       %>% 
                     mutate(date  = date_first,
                            id    = as.factor(prov),# CLASE factor
                                                    # CON TEXTO feature enginnering invalido
                            value.v = v.cases,
                            value.f = f.cases
                            ) %>% 
                     select(id,value.v,value.f,date,prcp_std,tmax_std)
 
class(db.pamafro$id)
class(db.pamafro$value)
class(db.pamafro$date)



```


## MALARIA CERO


```{r,message=F,warning=F}

db.mcero          <- readRDS("db_loreto_its.rds") %>% 
                     filter(year>=2011)       %>% 
                     mutate(date  = date_first,
                            id    = as.factor(prov),# CLASE factor
                                                    # CON TEXTO feature enginnering invalido
                            value.v = v.cases,
                            value.f = f.cases
                            ) %>% 
                     select(id,value.v,value.f,date,prcp_std,tmax_std)


```


# Descriptive analysis


```{r,message=F,warning=F}

db.pamafro %>% 
ggplot()+
geom_line(aes(date,value.v))+
theme_bw()+
facet_wrap(vars(id))
```




# Train test sample
* Del 2006 a atras se usa,es decir a partir de los datos de training  se crean las muestras/folds
  para llevar a cabo el tuning.
  
## PAMAFRO

```{r,message=F,warning=F}

splits_v_pfro          <-   db.pamafro                  %>%
                            select(-value.f)            %>% 
                            time_series_split(
                              assess     = "5 years",
                              cumulative = TRUE
                            )

resamples_kfold_v_pfro <- training(splits_v_pfro) %>% 
                          vfold_cv(v = 10)


#check View(training(splits_v))
################################################################################


splits_f_pfro <- db.pamafro                  %>%
                  select(-value.v)            %>% 
                  time_series_split(
                    assess     = "5 years",
                    cumulative = TRUE
                  )

resamples_kfold_f_pfro <-  training(splits_f_pfro) %>% 
                            vfold_cv(v = 10)

```


## MALARIA CERO

```{r,message=F,warning=F}


splits_v_mcero          <-    db.mcero                  %>%
                              select(-value.f)            %>% 
                              time_series_split(
                                assess     = "3 years",
                                cumulative = TRUE
                              )

resamples_kfold_v_mcero <- training(splits_v_mcero) %>% 
                           vfold_cv(v = 10)


#check View(training(splits_v_mcero))
################################################################################


splits_f_mcero <-   db.mcero                  %>%
                   select(-value.v)            %>% 
                   time_series_split(
                      assess     = "3 years",
                      cumulative = TRUE
                  )

resamples_kfold_f_mcero <-  training(splits_f_mcero) %>% 
                            vfold_cv(v = 10)


```



# Recipes 

## PAMAFRO

```{r,message=F,warning=F}



rec_obj_v_pfro     <-   recipe(value.v ~., training(splits_v_pfro)) %>%
                        step_mutate_at(id, fn = droplevels) %>%
                        step_timeseries_signature(date) %>%
                        #step_rm(date) %>% # esta parte de la receta elimina date
                                            # paso  que requiere xgboost
                        step_zv(all_predictors())%>%
                        step_dummy(all_nominal_predictors(), one_hot = TRUE)

rec_obj_f_pfro     <-   recipe(value.f ~., training(splits_f_pfro)) %>%
                        step_mutate_at(id, fn = droplevels) %>%
                        step_timeseries_signature(date) %>%
                        #step_rm(date) %>% # esta parte de la receta elimina date
                                           # paso  que requiere xgboost
                        step_zv(all_predictors())%>%
                        step_dummy(all_nominal_predictors(), one_hot = TRUE)


```

## MALARIA CERO

```{r,message=F,warning=F}



rec_obj_v_mcero     <-  recipe(value.v ~., training(splits_v_mcero)) %>%
                        step_mutate_at(id, fn = droplevels) %>%
                        step_timeseries_signature(date) %>%
                        #step_rm(date) %>% # esta parte de la receta elimina date
                                            # paso  que requiere xgboost
                        step_zv(all_predictors())%>%
                        step_dummy(all_nominal_predictors(), one_hot = TRUE)

rec_obj_f_mcero     <-  recipe(value.f ~., training(splits_f_mcero)) %>%
                        step_mutate_at(id, fn = droplevels) %>%
                        step_timeseries_signature(date) %>%
                        #step_rm(date) %>% # esta parte de la receta elimina date
                                           # paso  que requiere xgboost
                        step_zv(all_predictors())%>%
                        step_dummy(all_nominal_predictors(), one_hot = TRUE)


```



# Create model

```{r,message=F,warning=F}



model_ph_tune <- prophet_reg(  
                                mode            = "regression",
                                # growth = NULL,
                                growth               = tune(),
                                changepoint_range      = tune(),
                                seasonality_yearly   = tune()
                                ) %>%
                         set_engine("prophet") 





################################################################################
# Model
model_phxgb_tune <- prophet_boost(  
                                mode            = "regression",
                                # growth = NULL,
                                changepoint_num = tune(),
                                tree_depth      = tune(),
                                mtry            = tune(),
                                learn_rate      = tune()) %>%
                         set_engine("prophet_xgboost") 

###############################################################################

model_arxgb_tune <-    arima_boost(
                                seasonal_period = tune(),
                                seasonal_ar     = tune(),
                                seasonal_ma     = tune(),
                                tree_depth      = tune(),
                                mtry            = tune(),
                                learn_rate      = tune()
                               ) %>%
                          set_engine("arima_xgboost") 

###############################################################################


# modelo de red neuronal
model_nnetar_tune<- nnetar_reg(
                    # seasonal_ar  = tune(),
                     hidden_units = tune(),
                     num_networks = tune(),
                     penalty = tune()
                  ) %>%
                    set_engine("nnetar") 

```



# Create WLFW by specie

## PAMAFRO

### Vivax

```{r,message=F,warning=F}


# Workflow
wflw_ph_tune_v_pfro      <-   workflow() %>%
                          add_model(
                              model_ph_tune
                          ) %>%
                          add_recipe(rec_obj_v_pfro)



################################################################################
# Workflow
wflw_phxgb_tune_v_pfro      <-   workflow() %>%
                          add_model(
                              model_phxgb_tune
                          ) %>%
                          add_recipe(rec_obj_v_pfro)



################################################################################




wflw_arxgb_tune_v_pfro            <-  workflow() %>%
                              add_model(
                                   model_arxgb_tune
                              ) %>%
                              add_recipe(rec_obj_v_pfro) 


################################################################################
# Workflow red neuronal
# generamos el flujo y no ajustamos("fit") para correr modelos segun la validacion cruzada

wflw_nnetar_tune_v_pfro   <-  workflow() %>%
                      add_model(
                          model_nnetar_tune
                      ) %>%
                      add_recipe(rec_obj_v_pfro) 







```


### Falciparum

```{r,message=F,warning=F}



# Workflow
wflw_ph_tune_f_pfro      <-   workflow() %>%
                          add_model(
                              model_ph_tune
                          ) %>%
                          add_recipe(rec_obj_f_pfro)




#Ahora

# Workflow
wflw_phxgb_tune_f_pfro      <-   workflow() %>%
                                  add_model(
                                      model_phxgb_tune
                                  ) %>%
                                  add_recipe(rec_obj_f_pfro) 

################################################################################



wflw_arxgb_tune_f_pfro           <-  workflow() %>%
                                    add_model(
                                         model_arxgb_tune
                                    ) %>%
                                    add_recipe(rec_obj_f_pfro) 





################################################################################


# Workflow red neuronal
# generamos el flujo y no ajustamos("fit") para correr modelos segun la validacion cruzada
wflw_nnetar_tune_f_pfro  <-   workflow() %>%
                              add_model(
                                  model_nnetar_tune
                              ) %>%
                              add_recipe(rec_obj_f_pfro) 
        



```




## MALARIA CERO

### Vivax

```{r,message=F,warning=F}


# Workflow
wflw_ph_tune_v_mcero      <-   workflow() %>%
                          add_model(
                              model_ph_tune
                          ) %>%
                          add_recipe(rec_obj_v_mcero)




# Workflow
wflw_phxgb_tune_v_mcero      <-    workflow() %>%
                                  add_model(
                                      model_phxgb_tune
                                  ) %>%
                                  add_recipe(rec_obj_v_mcero)



################################################################################




wflw_arxgb_tune_v_mcero            <-  workflow() %>%
                                      add_model(
                                           model_arxgb_tune
                                      ) %>%
                                      add_recipe(rec_obj_v_mcero) 


################################################################################
# Workflow red neuronal
# generamos el flujo y no ajustamos("fit") para correr modelos segun la validacion cruzada

wflw_nnetar_tune_v_mcero   <-  workflow() %>%
                              add_model(
                                  model_nnetar_tune
                              ) %>%
                              add_recipe(rec_obj_v_mcero) 







```


### Falciparum

```{r,message=F,warning=F}

# Workflow
wflw_ph_tune_f_mcero      <-   workflow() %>%
                          add_model(
                              model_ph_tune
                          ) %>%
                          add_recipe(rec_obj_f_mcero)

#Ahora

# Workflow
wflw_phxgb_tune_f_mcero      <-   workflow() %>%
                                  add_model(
                                      model_phxgb_tune
                                  ) %>%
                                  add_recipe(rec_obj_f_mcero) 

################################################################################



wflw_arxgb_tune_f_mcero           <-  workflow() %>%
                                      add_model(
                                           model_arxgb_tune
                                      ) %>%
                                      add_recipe(rec_obj_f_mcero) 
        
        



################################################################################


# Workflow red neuronal
# generamos el flujo y no ajustamos("fit") para correr modelos segun la validacion cruzada

wflw_nnetar_tune_f_mcero  <-  workflow() %>%
                              add_model(
                                  model_nnetar_tune
                              ) %>%
                              add_recipe(rec_obj_f_mcero) 




```





# Generate grid search by model

```{r,message=F,warning=F}

set.seed(123)
grid_spec_ph_tune <- grid_latin_hypercube(
                        extract_parameter_set_dials(model_ph_tune) %>% 
                          update(
                          seasonality_yearly = seasonality_yearly(values = c(TRUE, FALSE)),
                          changepoint_range = changepoint_range(range = c(0.6, 0.9),trans = NULL)
                                                 ),
                              size = 10
                         )

# si realizar el tuning sin definir el parametro : 
# At least one parameter does not match any id's in the set: 'changepoint_range'


set.seed(123)
grid_spec_phxgb_tune <- grid_latin_hypercube(
                              extract_parameter_set_dials(model_phxgb_tune) %>% 
                                          update(learn_rate = learn_rate(range = c(0.1, 0.3)),
                                                 mtry       = mtry(range = c(1, 50)),
                                                 ),
                              size = 10
                         )

# Learning rate
# https://machinelearningmastery.com/tune-learning-rate-for-gradient-boosting-with-xgboost-in-python/


set.seed(123)
grid_spec_arxgb_tune <- grid_latin_hypercube(
                              extract_parameter_set_dials(model_arxgb_tune) %>% 
                                          update(learn_rate   = learn_rate(range = c(0.1, 0.3)),
                                                 mtry = mtry(range = c(1, 50)),
                                                 ),
                              size = 10
                        )



set.seed(123)
grid_spec_nnetar_tune <- grid_latin_hypercube(
                              extract_parameter_set_dials(model_nnetar_tune) %>% 
                                          update(hidden_units = hidden_units(range = c(0, 10)),
                                                 num_networks = num_networks(range = c(1, 50)),
                                                 ),
                              size = 10
                           )

```


# Hyperparameter Tuning

## PAMAFRO

### Vivax

```{r,message=F,warning=F}


library(tictoc)


################################################################################

tic()
tune_results_ph_v_pfro <- wflw_ph_tune_v_pfro %>%
                                tune_grid(
                                  resamples  = resamples_kfold_v_pfro,
                                  grid       = grid_spec_ph_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()


################################################################################
tic()
tune_results_phxgb_v_pfro <- wflw_phxgb_tune_v_pfro %>%
                                tune_grid(
                                  resamples  = resamples_kfold_v_pfro,
                                  grid       = grid_spec_phxgb_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()

################################################################################


tic()
tune_results_arxgb_v_pfro <- wflw_arxgb_tune_v_pfro %>%
                                tune_grid(
                                  resamples  = resamples_kfold_v_pfro,
                                  grid       = grid_spec_arxgb_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()


################################################################################

tic()
tune_results_nnetar_v_pfro <- wflw_nnetar_tune_v_pfro %>%
                                tune_grid(
                                  resamples  = resamples_kfold_v_pfro,
                                  grid       = grid_spec_nnetar_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()


saveRDS(tune_results_ph_v_pfro ,"tune_pamafro_ph_vivax_pfro_1_0.rds")
saveRDS(tune_results_phxgb_v_pfro ,"tune_pamafro_phxgb_vivax_pfro_1_0.rds")
saveRDS(tune_results_arxgb_v_pfro ,"tune_pamafro_arxgb_vivax_pfro_1_0.rds")
saveRDS(tune_results_nnetar_v_pfro,"tune_pamafro_nnetar_vivax_pfro_1_0.rds")


```


### Falciparum

```{r,message=F,warning=F}


library(tictoc)


tic()
tune_results_ph_f_pfro <- wflw_ph_tune_f_pfro %>%
                                tune_grid(
                                  resamples  = resamples_kfold_f_pfro,
                                  grid       = grid_spec_ph_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()


################################################################################
tic()
tune_results_phxgb_f_pfro <- wflw_phxgb_tune_f_pfro %>%
                                tune_grid(
                                  resamples  = resamples_kfold_f_pfro,
                                  grid       = grid_spec_phxgb_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()

################################################################################


tic()
tune_results_arxgb_f_pfro <- wflw_arxgb_tune_f_pfro %>%
                                tune_grid(
                                  resamples  = resamples_kfold_f_pfro,
                                  grid       = grid_spec_arxgb_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()


################################################################################

tic()
tune_results_nnetar_f_pfro <- wflw_nnetar_tune_f_pfro %>%
                                tune_grid(
                                  resamples  = resamples_kfold_f_pfro,
                                  grid       = grid_spec_nnetar_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()

saveRDS(tune_results_phxgb_f_pfro ,"tune_pamafro_ph_falciparum_1_0.rds")
saveRDS(tune_results_phxgb_f_pfro ,"tune_pamafro_phxgb_falciparum_1_0.rds")
saveRDS(tune_results_arxgb_f_pfro ,"tune_pamafro_arxgb_falciparum_1_0.rds")
saveRDS(tune_results_nnetar_f_pfro,"tune_pamafro_nnetar_falciparum_1_0.rds")


```



## MALARIA CERO

### Vivax

```{r,message=F,warning=F}


library(tictoc)
tic()
tune_results_ph_v_mcero      <- wflw_ph_tune_v_mcero %>%
                                tune_grid(
                                  resamples  = resamples_kfold_v_mcero,
                                  grid       = grid_spec_ph_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()

#############################################################################

tic()
tune_results_phxgb_v_mcero <- wflw_phxgb_tune_v_mcero %>%
                                tune_grid(
                                  resamples  = resamples_kfold_v_mcero,
                                  grid       = grid_spec_phxgb_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()

################################################################################


tic()
tune_results_arxgb_v_mcero <- wflw_arxgb_tune_v_mcero %>%
                                tune_grid(
                                  resamples  = resamples_kfold_v_mcero,
                                  grid       = grid_spec_arxgb_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()


################################################################################

tic()
tune_results_nnetar_v_mcero   <-  wflw_nnetar_tune_v_mcero %>%
                                  tune_grid(
                                    resamples  = resamples_kfold_v_mcero,
                                    grid       = grid_spec_nnetar_tune,
                                    control    = control_grid(verbose = TRUE, 
                                                            allow_par = TRUE)
                                  )
toc()

saveRDS(tune_results_ph_v_mcero ,"tune_mcero_ph_vivax_1_0.rds")
saveRDS(tune_results_phxgb_v_mcero ,"tune_mcero_phxgb_vivax_1_0.rds")
saveRDS(tune_results_arxgb_v_mcero ,"tune_mcero_arxgb_vivax_1_0.rds")
saveRDS(tune_results_nnetar_v_mcero,"tune_mcero_nnetar_vivax_1_0.rds")


```


### Falciparum

```{r,message=F,warning=F}


library(tictoc)


tic()
tune_results_ph_f_mcero <- wflw_ph_tune_f_mcero %>%
                                tune_grid(
                                  resamples  = resamples_kfold_f_mcero,
                                  grid       = grid_spec_ph_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()

################################################################################

tic()
tune_results_phxgb_f_mcero <- wflw_phxgb_tune_f_mcero %>%
                                tune_grid(
                                  resamples  = resamples_kfold_f_mcero,
                                  grid       = grid_spec_phxgb_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()

################################################################################


tic()
tune_results_arxgb_f_mcero <- wflw_arxgb_tune_f_mcero %>%
                                tune_grid(
                                  resamples  = resamples_kfold_f_mcero,
                                  grid       = grid_spec_arxgb_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()


################################################################################

tic()
tune_results_nnetar_f_mcero <- wflw_nnetar_tune_f_mcero %>%
                                tune_grid(
                                  resamples  = resamples_kfold_f_mcero,
                                  grid       = grid_spec_nnetar_tune,
                                  control    = control_grid(verbose = TRUE, 
                                                          allow_par = TRUE)
                                )
toc()


saveRDS(tune_results_ph_f_mcero ,"tune_mcero_ph_falciparum_1_0.rds")
saveRDS(tune_results_phxgb_f_mcero ,"tune_mcero_phxgb_falciparum_1_0.rds")
saveRDS(tune_results_arxgb_f_mcero ,"tune_mcero_arxgb_falciparum_1_0.rds")
saveRDS(tune_results_nnetar_f_mcero,"tune_mcero_nnetar_falciparum_1_0.rds")


```


# Select the best model accord to error criteria

## PAMAFRO

### Vivax


```{r,message=F,warning=F}



set.seed(123)
wflw_fit_ph_tuned_v_pfro   <-    wflw_ph_tune_v_pfro %>%
                                 finalize_workflow(
                                 select_best(tune_results_ph_v_pfro, "rmse", n=1)) %>%
                                 fit(training(splits_v_pfro))



set.seed(123)
wflw_fit_phxgb_tuned_v_pfro <-    wflw_phxgb_tune_v_pfro %>%
                                 finalize_workflow(
                                 select_best(tune_results_phxgb_v_pfro, "rmse", n=1)) %>%
                                 fit(training(splits_v_pfro))



set.seed(123)
wflw_fit_arxgb_tuned_v_pfro <-     wflw_arxgb_tune_v_pfro %>%
                                   finalize_workflow(
                                   select_best(tune_results_arxgb_v_pfro, "rmse", n=1)) %>%
                                   fit(training(splits_v_pfro))


set.seed(123)
wflw_fit_nnetar_tuned_v_pfro <-  wflw_nnetar_tune_v_pfro %>%
                                 finalize_workflow(
                                 select_best(tune_results_nnetar_v_pfro, "rmse", n=1)) %>%
                                 fit(training(splits_v_pfro))



```

### Falciparum

```{r,message=F,warning=F}

# Pocas son las medidas que acepta para seleccionar el mejor modelo

set.seed(123)
wflw_fit_phxgb_tuned_f_pfro <-    wflw_phxgb_tune_f_pfro %>%
                           finalize_workflow(
                           select_best(tune_results_phxgb_f_pfro, "rmse", n=1)) %>%
                           fit(training(splits_f_pfro))



set.seed(123)
wflw_fit_arxgb_tuned_f_pfro <-      wflw_arxgb_tune_f_pfro %>%
                             finalize_workflow(
                             select_best(tune_results_arxgb_f_pfro, "rmse", n=1)) %>%
                             fit(training(splits_f_pfro))


set.seed(123)
wflw_fit_nnetar_tuned_f_pfro <-      wflw_nnetar_tune_f_pfro %>%
                                     finalize_workflow(
                                     select_best(tune_results_nnetar_f_pfro, "rmse", n=1)) %>%
                                     fit(training(splits_f_pfro))

# modeltime_table(wflw_fit_prophet_boost_tuned) %>%
#   modeltime_calibrate(testing(splits)) %>%
#   modeltime_accuracy()

#modeltime_calibrate, esto serviria para calcular los valores ajustados

```








## MALARIA CERO

### Vivax


```{r,message=F,warning=F}

set.seed(123)
wflw_fit_ph_tuned_v_mcero    <-    wflw_ph_tune_v_mcero %>%
                                   finalize_workflow(
                                   select_best(tune_results_ph_v_mcero, "rmse", n=1)) %>%
                                   fit(training(splits_v_mcero))


set.seed(123)
wflw_fit_phxgb_tuned_v_mcero <-    wflw_phxgb_tune_v_mcero %>%
                                   finalize_workflow(
                                   select_best(tune_results_phxgb_v_mcero, "rmse", n=1)) %>%
                                   fit(training(splits_v_mcero))



set.seed(123)
wflw_fit_arxgb_tuned_v_mcero <-  wflw_arxgb_tune_v_mcero %>%
                                 finalize_workflow(
                                 select_best(tune_results_arxgb_v_mcero, "rmse", n=1)) %>%
                                 fit(training(splits_v_mcero))


set.seed(123)
wflw_fit_nnetar_tuned_v_mcero <-   wflw_nnetar_tune_v_mcero %>%
                                   finalize_workflow(
                                   select_best(tune_results_nnetar_v_mcero, "rmse", n=1)) %>%
                                   fit(training(splits_v_mcero))



```

### Falciparum

```{r,message=F,warning=F}

set.seed(123)
wflw_fit_ph_tuned_f_mcero  <-  wflw_ph_tune_f_mcero %>%
                               finalize_workflow(
                               select_best(tune_results_ph_f_mcero, "rmse", n=1)) %>%
                               fit(training(splits_f_mcero))


# Pocas son las medidas que acepta para seleccionar el mejor modelo: RMSE
set.seed(123)
wflw_fit_phxgb_tuned_f_mcero <-  wflw_phxgb_tune_f_mcero %>%
                                 finalize_workflow(
                                 select_best(tune_results_phxgb_f_mcero, "rmse", n=1)) %>%
                                 fit(training(splits_f_mcero))



set.seed(123)
wflw_fit_arxgb_tuned_f_mcero <-      wflw_arxgb_tune_f_mcero %>%
                             finalize_workflow(
                             select_best(tune_results_arxgb_f_mcero, "rmse", n=1)) %>%
                             fit(training(splits_f_mcero))


set.seed(123)
wflw_fit_nnetar_tuned_f_mcero <-   wflw_nnetar_tune_f_mcero %>%
                                   finalize_workflow(
                                   select_best(tune_results_nnetar_f_mcero, "rmse", n=1)) %>%
                                   fit(training(splits_f_mcero))

# modeltime_table(wflw_fit_prophet_boost_tuned) %>%
#   modeltime_calibrate(testing(splits)) %>%
#   modeltime_accuracy()

#modeltime_calibrate, esto serviria para calcular los valores ajustados

```








# modeltime table by specie

## PAMAFRO

```{r,message=F,warning=F}



# model_tbl <- modeltime_table(
#               wflw_phxgb,
#               wflw_arxgb,
#               wflw_nnetar
# )


model_tbl_v_pfro <- modeltime_table(
                    wflw_fit_phxgb_tuned_v_pfro,
                    wflw_fit_arxgb_tuned_v_pfro,
                    wflw_fit_nnetar_tuned_v_pfro
)



model_tbl_f_pfro <- modeltime_table(
              wflw_fit_phxgb_tuned_f_pfro,
              wflw_fit_arxgb_tuned_f_pfro,
              wflw_fit_nnetar_tuned_f_pfro
)

# sw_tidy(wflw_fit_prophet_boost_tuned)
# sw_tidy(wflw_nnetar)
# sw_tidy(model_tbl)


```

## MALARIA CERO

```{r,message=F,warning=F}



# model_tbl <- modeltime_table(
#               wflw_phxgb,
#               wflw_arxgb,
#               wflw_nnetar
# )


model_tbl_v_mcero <- modeltime_table(
              wflw_fit_phxgb_tuned_v_mcero,
              wflw_fit_arxgb_tuned_v_mcero,
              wflw_fit_nnetar_tuned_v_mcero
)



model_tbl_f_mcero <- modeltime_table(
              wflw_fit_phxgb_tuned_f_mcero,
              wflw_fit_arxgb_tuned_f_mcero,
              wflw_fit_nnetar_tuned_f_mcero
)

# sw_tidy(wflw_fit_prophet_boost_tuned)
# sw_tidy(wflw_nnetar)
# sw_tidy(model_tbl)


```



# fitted values

```{r}
#install.packages("sweep")
library(sweep)
#sw_augment(wflw_fit_prophet_boost_tuned) # error falta new_data
sw_augment(model_pet_boost_tune)

sw_augment(wflw_nnetar)
sw_augment(model_nnetar_tune)


```


# calibrate by ID ( province) and specie **

## PAMAFRO

```{r,message=F,warning=F}

calib_tbl_v_pfro <-   model_tbl_v_pfro %>%
                      modeltime_calibrate(
                        new_data = testing(splits_v_pfro), 
                        id       = "id",
                        quiet = FALSE
                      )


calib_tbl_f_pfro <-   model_tbl_f_pfro %>%
                      modeltime_calibrate(
                        new_data = testing(splits_f_pfro), 
                        id       = "id",
                        quiet = FALSE
                      )

# calib_tbl
# sw_augment(calib_tbl)



# calibration_all_tbl <- model_tbl %>%
#                        modeltime_calibrate(testing(splits))


```


## MALARIA CERO

```{r,message=F,warning=F}

calib_tbl_v_mcero <-  model_tbl_v_mcero %>%
                      modeltime_calibrate(
                        new_data = testing(splits_v_mcero), 
                        id       = "id",
                        quiet = FALSE
                      )


calib_tbl_f_mcero <-  model_tbl_f_mcero %>%
                      modeltime_calibrate(
                        new_data = testing(splits_f_mcero), 
                        id       = "id",
                        quiet = FALSE
                      )

# calib_tbl
# sw_augment(calib_tbl)



# calibration_all_tbl <- model_tbl %>%
#                        modeltime_calibrate(testing(splits))


```




# Accuracy table

## Global

```{r,message=F,warning=F}

  calib_tbl %>% 
  modeltime_accuracy(acc_by_id = FALSE) %>% 
  table_modeltime_accuracy(.interactive = FALSE)




```


## Local


```{r,message=F,warning=F}

calib_tbl %>% 
    modeltime_accuracy(acc_by_id = TRUE) %>% 
    table_modeltime_accuracy(.interactive = FALSE)

```


# Forecasting 

## PAMAFRO

```{r,message=F,warning=F}

tbl.forecast_v_pfro  <-  calib_tbl_v_pfro %>%
                  modeltime_forecast(
                      new_data    = testing(splits_v_pfro),
                      actual_data = db.pamafro,
                      conf_by_id  = TRUE
                  ) %>%
                  group_by(id) %>%
                  plot_modeltime_forecast(
                      .facet_ncol  = 3,
                      .interactive = FALSE
                  )

#Informacion de prediccion para graficar, y demas calculos descriptivos
db.tbl.frcst_v_pfro<-tbl.forecast_v_pfro$data

saveRDS(db.tbl.frcst_v_pfro,"db_frcst_bestmodels_vx_pfro.rds")
#saveRDS(db.tbl.frcst_v,"db_frcst_bestmodels_vx.rds")

# class(calibration_all_tbl) 
# md<-modeltime_refit(calib_tbl,data = training(splits))
# class(md)
# 
# md$.model_id
# md$.model
# 
# sw_tidy(md$.model)



################################################################################

tbl.forecast_f_pfro  <-  calib_tbl_f_pfro %>%
                  modeltime_forecast(
                      new_data    = testing(splits_f_pfro),
                      actual_data = db.pamafro,
                      conf_by_id  = TRUE
                  ) %>%
                  group_by(id) %>%
                  plot_modeltime_forecast(
                      .facet_ncol  = 3,
                      .interactive = FALSE
                  )

#Informacion de prediccion para graficar, y demas calculos descriptivos
db.tbl.frcst_f_pfro<-tbl.forecast_f_pfro$data

saveRDS(db.tbl.frcst_f_pfro,"db_frcst_bestmodels_flcpm_pfro.rds")



```



## MALARIA CERO

```{r,message=F,warning=F}

tbl.forecast_v_mcero  <-  calib_tbl_v_mcero %>%
                  modeltime_forecast(
                      new_data    = testing(splits_v_mcero),
                      actual_data = db.mcero,
                      conf_by_id  = TRUE
                  ) %>%
                  group_by(id) %>%
                  plot_modeltime_forecast(
                      .facet_ncol  = 3,
                      .interactive = FALSE
                  )

#Informacion de prediccion para graficar, y demas calculos descriptivos
db.tbl.frcst_v_mcero<-tbl.forecast_v_mcero$data

saveRDS(db.tbl.frcst_v_mcero,"db_frcst_bestmodels_vx_mcero.rds")
#saveRDS(db.tbl.frcst_v,"db_frcst_bestmodels_vx.rds")

# class(calibration_all_tbl) 
# md<-modeltime_refit(calib_tbl,data = training(splits))
# class(md)
# 
# md$.model_id
# md$.model
# 
# sw_tidy(md$.model)



################################################################################

tbl.forecast_f_mcero  <-  calib_tbl_f_mcero %>%
                  modeltime_forecast(
                      new_data    = testing(splits_f_mcero),
                      actual_data = db.mcero,
                      conf_by_id  = TRUE
                  ) %>%
                  group_by(id) %>%
                  plot_modeltime_forecast(
                      .facet_ncol  = 3,
                      .interactive = FALSE
                  )

#Informacion de prediccion para graficar, y demas calculos descriptivos
db.tbl.frcst_f_mcero<-tbl.forecast_f_mcero$data

saveRDS(db.tbl.frcst_f_mcero,"db_frcst_bestmodels_flcpm_mcero.rds")



```




# Fitted values training set

```{r,message=F,warning=F}


library(sweep)
library(forecast)
md.arima <-  db.pamafro             %>%
             filter(id=="UCAYALI")  


pamafro_ts <- tk_ts(md.arima, start = 2001, freq = 12, silent = TRUE)

fit_ets <- pamafro_ts %>%
            ets()


fit_arima <- pamafro_ts %>%
            arima()

#requier objeto como ts
fit_nntar <- pamafro_ts %>%
             nnetar()

fit_tbats <- pamafro_ts %>%
             tbats()

#install.packages("fable") # tiene mas modelos de series de tiempo explorar
# install.packages("fable.prophet")

pam.ts.tbl<- db.pamafro  %>%
             filter(id=="UCAYALI")  %>% 
              as_tsibble()

library(fable.prophet)
fit_pro <- db.pamafro %>%
             prophet(value ~ growth("linear") + season("year", type = "multiplicative"))

components(fit_pro)
fitted(fit_pro)


fit_ets%>%
   sw_augment()

fit_arima%>%
   sw_augment()

fit_nntar%>%
   sw_augment()


fit_tbats%>%
   sw_augment()

#Parameter
fit_ets   %>%
sw_tidy(conf.int = TRUE)




# arima boost

# Set engine and boosting parameters
model_spec <- arima_boost(

    # ARIMA args
    seasonal_period = 12,
    non_seasonal_ar = 0,
    non_seasonal_differences = 1,
    non_seasonal_ma = 1,
    seasonal_ar     = 0,
    seasonal_differences = 1,
    seasonal_ma     = 1,

    # XGBoost Args
    tree_depth = 6,
    learn_rate = 0.1
) %>%
    set_engine(engine = "arima_xgboost")

# FIT ----

# \donttest{
# Boosting - Happens by adding numeric date and month features
model_fit_boosted <- model_spec %>%
    fit(value ~ date + as.numeric(date) + month(date, label = TRUE),
        data = training(splits))

model_fit_boosted


# references

# https://robjhyndman.com/hyndsight/nnetar-prediction-intervals/

   
```


